---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# marlin

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/mar)](https://CRAN.R-project.org/package=mar)
<!-- badges: end -->

marlin is a package for efficiently running simulations of marine fauna and fisheries. Age-structured population model of different (independent) animal types in a 2D system with multiple fishing fleets. 

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("DanOvando/marlin")
```
## Example

Create two critters, skipjack tuna and bigeye tuna, and simulate their unfished conditions

```{r example}
library(marlin)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
resolution <- 25
habitat <- expand_grid(x = 1:resolution, y = 1:resolution) %>%
  mutate(habitat =  dnorm((x ^ 2 + y ^ 2), 600, 100))

habitat_mat <-
  matrix(
    rep(habitat$habitat, resolution),
    nrow = resolution ^ 2,
    ncol = resolution ^ 2,
    byrow = TRUE
  )

skj_hab <- habitat_mat / rowSums(habitat_mat)

habitat <- expand_grid(x = 1:resolution, y = 1:resolution) %>%
  mutate(habitat =  dnorm((x ^ 2 + y ^ 2), 600, 100))

habitat_mat <-
  matrix(
    rep(habitat$habitat, resolution),
    nrow = resolution ^ 2,
    ncol = resolution ^ 2,
    byrow = TRUE
  )

bet_hab <- habitat_mat / rowSums(habitat_mat)


fauna <-
  list(
    "skipjack" = create_critter(
      scientific_name = "Katsuwonus pelamis",
      habitat = skj_hab,
      adult_movement = 1,
      fished_depletion = .7
    ),
    "bigeye" = create_critter(
      common_name = "bigeye tuna",
      habitat = bet_hab,
      adult_movement = 100,
      fished_depletion = 0.2
    )
  )


fleets <- list("longline" = list(
  skipjack = list(
    price = 100,
    sel_form = "logistic",
    sel_start = 0,
    sel_delta = .1,
    catchability = 0
  ),
  bigeye = list(
    price = 1000,
    sel_form = "logistic",
    sel_start = .25,
    sel_delta = .01,
    catchability = 0.1
  )
),
"purseseine" = list(
  skipjack = list(
    price = 100,
    sel_form = "logistic",
    sel_start = 0,
    sel_delta = .1,
    catchability = .9
  ),
  bigeye = list(
    price = 100,
    sel_form = "logistic",
    sel_start = 1,
    sel_delta = .01,
    catchability = .1
  )
))



fleets <- create_fleet(fleets = fleets, fauna = fauna, base_effort = resolution^2)


fleets <- tune_fleets(fauna, fleets, steps = 100)


# run simulations
steps <- 100

a <- Sys.time()

storage <- simmar(fauna = fauna,
                  fleets = fleets,
                  steps = steps)

Sys.time() - a
  
  
rec <- map(storage, ~ .x[[2]]$n_p_a) %>%
  map_df( ~ tibble(rec = .x[, 1]), .id = "i") %>%
  mutate(i = as.numeric(i)) %>%
  filter(i > 1) %>%
  group_by(i) %>%
  summarise(recs = sum(rec))

ssb <- map(storage, ~ .x[[2]]$ssb_p_a) %>%
  map_df( ~ tibble(ssb = rowSums(.x)), .id = "i") %>%
  mutate(i = as.numeric(i)) %>%
  filter(i > 1) %>%
  group_by(i) %>%
  summarise(ssb = sum(ssb))


ssb_skj <- rowSums(storage[[steps]]$skipjack$ssb_p_a)

check <- expand_grid(x = 1:resolution, y = 1:resolution) %>%
  mutate(skj = ssb_skj)

ggplot(check, aes(x, y, fill = skj)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "skipjack")

ssb_bet <- rowSums(storage[[steps]]$bigeye$ssb_p_a)

check <- expand_grid(x = 1:resolution, y = 1:resolution) %>%
  mutate(bet = ssb_bet)

ggplot(check, aes(x, y, fill = bet)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "bigeye")



```

